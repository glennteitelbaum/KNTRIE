<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>kntrie Benchmark</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<style>
  body { margin:0; background:#0f0f1a; color:#ddd; font-family:system-ui,sans-serif; }
  .wrap { max-width:700px; margin:0 auto; padding:16px 12px; }
  h2 { margin:0 0 4px; font-size:18px; font-weight:700; text-align:center; }
  .sub { text-align:center; color:#777; font-size:12px; margin:0 0 12px; }
  .btns { display:flex; justify-content:center; gap:8px; margin-bottom:16px; }
  .btns button { padding:6px 16px; border-radius:6px; border:1px solid #444;
    background:#1a1a2e; color:#aaa; cursor:pointer; font-size:13px; font-weight:600; }
  .btns button.active { background:#3b82f6; color:#fff; }
  .chart-box { margin-bottom:24px; }
  .chart-box h3 { margin:0 0 6px; font-size:14px; font-weight:600; text-align:center; }
  canvas { background:#12122a; border-radius:8px; }
</style>
</head>
<body>
<div class="wrap">
  <h2>kntrie Benchmark (u64 &rarr; i32)</h2>
  <p class="sub">Log-log &middot; Per-entry &middot; Lower is better &middot; FND=100% hit, NF=100% miss</p>
  <div class="btns">
    <button class="active" onclick="show('random')">random</button>
    <button onclick="show('sequential')">sequential</button>
  </div>
  <div class="chart-box"><h3>Find (ns/entry)</h3><canvas id="c_find"></canvas></div>
  <div class="chart-box"><h3>Iteration (ns/entry)</h3><canvas id="c_iter"></canvas></div>
  <div class="chart-box"><h3>Insert (ns/entry)</h3><canvas id="c_insert"></canvas></div>
  <div class="chart-box"><h3>Erase N/2 (ns/entry)</h3><canvas id="c_erase"></canvas></div>
  <div class="chart-box"><h3>Memory (B/entry)</h3><canvas id="c_mem"></canvas></div>
</div>
<script>
const RAW_DATA = [
  {pattern:"random",N:100,kntrie_fnd:0.0009,kntrie_nf:0.0007,kntrie_insert:0.0198,kntrie_erase:0.0065,kntrie_iter:0.0032,kntrie_mem:26200,map_fnd:0.0037,map_nf:0.0027,map_insert:0.0143,map_erase:0.0089,map_iter:0.0015,map_mem:4800,umap_fnd:0.0015,umap_nf:0.0021,umap_insert:0.0059,umap_erase:0.0024,umap_iter:0.0003,umap_mem:3224,kntrie_memneeded:1544},
  {pattern:"random",N:150,kntrie_fnd:0.0013,kntrie_nf:0.0011,kntrie_insert:0.0197,kntrie_erase:0.0069,kntrie_iter:0.0047,kntrie_mem:27736,map_fnd:0.0060,map_nf:0.0048,map_insert:0.0201,map_erase:0.0125,map_iter:0.0022,map_mem:7200,umap_fnd:0.0021,umap_nf:0.0024,umap_insert:0.0076,umap_erase:0.0033,umap_iter:0.0004,umap_mem:4856,kntrie_memneeded:3080},
  {pattern:"random",N:225,kntrie_fnd:0.0021,kntrie_nf:0.0018,kntrie_insert:0.0209,kntrie_erase:0.0081,kntrie_iter:0.0066,kntrie_mem:27736,map_fnd:0.0098,map_nf:0.0082,map_insert:0.0291,map_erase:0.0163,map_iter:0.0029,map_mem:10800,umap_fnd:0.0035,umap_nf:0.0048,umap_insert:0.0108,umap_erase:0.0047,umap_iter:0.0005,umap_mem:7216,kntrie_memneeded:3080},
  {pattern:"random",N:337,kntrie_fnd:0.0036,kntrie_nf:0.0030,kntrie_insert:0.0278,kntrie_erase:0.0111,kntrie_iter:0.0108,kntrie_mem:30808,map_fnd:0.0157,map_nf:0.0140,map_insert:0.0408,map_erase:0.0234,map_iter:0.0039,map_mem:16176,umap_fnd:0.0050,umap_nf:0.0072,umap_insert:0.0139,umap_erase:0.0062,umap_iter:0.0007,umap_mem:10784,kntrie_memneeded:6152},
  {pattern:"random",N:506,kntrie_fnd:0.0054,kntrie_nf:0.0045,kntrie_insert:0.0594,kntrie_erase:0.0154,kntrie_iter:0.0161,kntrie_mem:30808,map_fnd:0.0262,map_nf:0.0223,map_insert:0.0627,map_erase:0.0384,map_iter:0.0057,map_mem:24288,umap_fnd:0.0071,umap_nf:0.0101,umap_insert:0.0189,umap_erase:0.0087,umap_iter:0.0010,umap_mem:16472,kntrie_memneeded:6152},
  {pattern:"random",N:759,kntrie_fnd:0.0085,kntrie_nf:0.0075,kntrie_insert:0.0631,kntrie_erase:0.0228,kntrie_iter:0.0263,kntrie_mem:36952,map_fnd:0.0429,map_nf:0.0377,map_insert:0.1002,map_erase:0.0533,map_iter:0.0085,map_mem:36432,umap_fnd:0.0112,umap_nf:0.0165,umap_insert:0.0268,umap_erase:0.0122,umap_iter:0.0015,umap_mem:24304,kntrie_memneeded:12296},
  {pattern:"random",N:1139,kntrie_fnd:0.0146,kntrie_nf:0.0134,kntrie_insert:0.0954,kntrie_erase:0.0309,kntrie_iter:0.0422,kntrie_mem:49240,map_fnd:0.0744,map_nf:0.0664,map_insert:0.1411,map_erase:0.0765,map_iter:0.0140,map_mem:54672,umap_fnd:0.0165,umap_nf:0.0231,umap_insert:0.0373,umap_erase:0.0174,umap_iter:0.0026,umap_mem:36880,kntrie_memneeded:24584},
  {pattern:"random",N:1708,kntrie_fnd:0.0217,kntrie_nf:0.0178,kntrie_insert:0.1411,kntrie_erase:0.0445,kntrie_iter:0.0634,kntrie_mem:49240,map_fnd:0.1265,map_nf:0.1120,map_insert:0.2177,map_erase:0.1237,map_iter:0.0216,map_mem:81984,umap_fnd:0.0266,umap_nf:0.0378,umap_insert:0.0532,umap_erase:0.0274,umap_iter:0.0049,umap_mem:54920,kntrie_memneeded:24584},
  {pattern:"random",N:2562,kntrie_fnd:0.0370,kntrie_nf:0.0312,kntrie_insert:0.2179,kntrie_erase:0.0647,kntrie_iter:0.1029,kntrie_mem:73816,map_fnd:0.2078,map_nf:0.1935,map_insert:0.3417,map_erase:0.1923,map_iter:0.0325,map_mem:122976,umap_fnd:0.0403,umap_nf:0.0567,umap_insert:0.0796,umap_erase:0.0405,umap_iter:0.0085,umap_mem:83512,kntrie_memneeded:49160},
  {pattern:"random",N:3844,kntrie_fnd:0.0547,kntrie_nf:0.0465,kntrie_insert:0.3691,kntrie_erase:0.1021,kntrie_iter:0.1545,kntrie_mem:73816,map_fnd:0.3445,map_nf:0.3274,map_insert:0.5234,map_erase:0.3101,map_iter:0.0532,map_mem:184512,umap_fnd:0.0637,umap_nf:0.0864,umap_insert:0.1246,umap_erase:0.0644,umap_iter:0.0143,umap_mem:124472,kntrie_memneeded:49160},
  {pattern:"random",N:5766,kntrie_fnd:0.0814,kntrie_nf:0.0708,kntrie_insert:0.7139,kntrie_erase:0.2323,kntrie_iter:0.2037,kntrie_mem:202992,map_fnd:0.5710,map_nf:0.5650,map_insert:0.8619,map_erase:0.4917,map_iter:0.0763,map_mem:276768,umap_fnd:0.0998,umap_nf:0.1406,umap_insert:0.1817,umap_erase:0.0989,umap_iter:0.0234,umap_mem:186008,kntrie_memneeded:99984},
  {pattern:"random",N:8649,kntrie_fnd:0.1541,kntrie_nf:0.1447,kntrie_insert:0.7778,kntrie_erase:0.2623,kntrie_iter:0.3221,kntrie_mem:318616,map_fnd:0.9503,map_nf:0.9355,map_insert:1.3089,map_erase:0.7775,map_iter:0.1348,map_mem:415152,umap_fnd:0.1514,umap_nf:0.2074,umap_insert:0.2878,umap_erase:0.1560,umap_iter:0.0363,umap_mem:277840,kntrie_memneeded:162192},
  {pattern:"random",N:12974,kntrie_fnd:0.2112,kntrie_nf:0.1726,kntrie_insert:1.1369,kntrie_erase:0.3885,kntrie_iter:0.4907,kntrie_mem:403912,map_fnd:1.5715,map_nf:1.5706,map_insert:2.1099,map_erase:1.2266,map_iter:0.1953,map_mem:622752,umap_fnd:0.2332,umap_nf:0.3291,umap_insert:0.4410,umap_erase:0.2353,umap_iter:0.0573,umap_mem:415240,kntrie_memneeded:207504},
  {pattern:"random",N:19461,kntrie_fnd:0.3537,kntrie_nf:0.2999,kntrie_insert:1.6841,kntrie_erase:0.6046,kntrie_iter:0.8108,kntrie_mem:575952,map_fnd:2.9911,map_nf:2.6647,map_insert:3.3487,map_erase:2.0478,map_iter:0.3237,map_mem:934128,umap_fnd:0.3480,umap_nf:0.4751,umap_insert:0.6365,umap_erase:0.3447,umap_iter:0.0905,umap_mem:633088,kntrie_memneeded:379152},
  {pattern:"random",N:29192,kntrie_fnd:0.5550,kntrie_nf:0.4770,kntrie_insert:2.5007,kntrie_erase:0.9261,kntrie_iter:1.1935,kntrie_mem:624336,map_fnd:4.7899,map_nf:4.6145,map_insert:5.3738,map_erase:3.3094,map_iter:0.6433,map_mem:1401216,umap_fnd:0.5424,umap_nf:0.7539,umap_insert:0.9975,umap_erase:0.5534,umap_iter:0.1508,umap_mem:946424,kntrie_memneeded:427536},
  {pattern:"random",N:43789,kntrie_fnd:0.9375,kntrie_nf:0.8329,kntrie_insert:4.1332,kntrie_erase:1.5252,kntrie_iter:1.9307,kntrie_mem:988368,map_fnd:8.7653,map_nf:8.2966,map_insert:8.8575,map_erase:5.8641,map_iter:1.3623,map_mem:2101872,umap_fnd:0.8765,umap_nf:1.2344,umap_insert:1.5733,umap_erase:1.0074,umap_iter:0.2542,umap_mem:1414784,kntrie_memneeded:791568},
  {pattern:"random",N:65684,kntrie_fnd:1.7512,kntrie_nf:1.5959,kntrie_insert:6.3608,kntrie_erase:2.1818,kntrie_iter:2.9866,kntrie_mem:1378512,map_fnd:15.1287,map_nf:14.2709,map_insert:16.0072,map_erase:9.9653,map_iter:2.6283,map_mem:3152832,umap_fnd:1.5080,umap_nf:2.0599,umap_insert:2.4758,umap_erase:1.6644,umap_iter:0.4613,umap_mem:2114872,kntrie_memneeded:1181712},
  {pattern:"random",N:98526,kntrie_fnd:2.6898,kntrie_nf:2.0979,kntrie_insert:9.2822,kntrie_erase:4.0500,kntrie_iter:4.6519,kntrie_mem:1774800,map_fnd:27.4271,map_nf:26.4917,map_insert:24.5602,map_erase:16.4610,map_iter:4.4515,map_mem:4729248,umap_fnd:2.4325,umap_nf:3.2852,umap_insert:4.3608,umap_erase:2.9949,umap_iter:0.9386,umap_mem:3162488,kntrie_memneeded:1578000},
  {pattern:"sequential",N:100,kntrie_fnd:0.0008,kntrie_nf:0.0007,kntrie_insert:0.0120,kntrie_erase:0.0060,kntrie_iter:0.0031,kntrie_mem:26200,map_fnd:0.0037,map_nf:0.0037,map_insert:0.0120,map_erase:0.0075,map_iter:0.0016,map_mem:4800,umap_fnd:0.0003,umap_nf:0.0007,umap_insert:0.0028,umap_erase:0.0019,umap_iter:0.0003,umap_mem:3224,kntrie_memneeded:1544},
  {pattern:"sequential",N:150,kntrie_fnd:0.0014,kntrie_nf:0.0012,kntrie_insert:0.0173,kntrie_erase:0.0068,kntrie_iter:0.0046,kntrie_mem:27736,map_fnd:0.0059,map_nf:0.0059,map_insert:0.0200,map_erase:0.0107,map_iter:0.0019,map_mem:7200,umap_fnd:0.0005,umap_nf:0.0011,umap_insert:0.0048,umap_erase:0.0022,umap_iter:0.0003,umap_mem:4856,kntrie_memneeded:3080},
  {pattern:"sequential",N:225,kntrie_fnd:0.0020,kntrie_nf:0.0018,kntrie_insert:0.0176,kntrie_erase:0.0070,kntrie_iter:0.0065,kntrie_mem:27736,map_fnd:0.0100,map_nf:0.0102,map_insert:0.0275,map_erase:0.0147,map_iter:0.0027,map_mem:10800,umap_fnd:0.0008,umap_nf:0.0016,umap_insert:0.0066,umap_erase:0.0026,umap_iter:0.0005,umap_mem:7216,kntrie_memneeded:3080},
  {pattern:"sequential",N:337,kntrie_fnd:0.0035,kntrie_nf:0.0030,kntrie_insert:0.0299,kntrie_erase:0.0113,kntrie_iter:0.0107,kntrie_mem:30808,map_fnd:0.0161,map_nf:0.0165,map_insert:0.0411,map_erase:0.0219,map_iter:0.0038,map_mem:16176,umap_fnd:0.0012,umap_nf:0.0024,umap_insert:0.0092,umap_erase:0.0030,umap_iter:0.0007,umap_mem:10784,kntrie_memneeded:6152},
  {pattern:"sequential",N:506,kntrie_fnd:0.0053,kntrie_nf:0.0045,kntrie_insert:0.0479,kntrie_erase:0.0138,kntrie_iter:0.0159,kntrie_mem:30808,map_fnd:0.0262,map_nf:0.0263,map_insert:0.0630,map_erase:0.0350,map_iter:0.0056,map_mem:24288,umap_fnd:0.0018,umap_nf:0.0039,umap_insert:0.0126,umap_erase:0.0041,umap_iter:0.0010,umap_mem:16472,kntrie_memneeded:6152},
  {pattern:"sequential",N:759,kntrie_fnd:0.0090,kntrie_nf:0.0077,kntrie_insert:0.0635,kntrie_erase:0.0231,kntrie_iter:0.0261,kntrie_mem:36952,map_fnd:0.0430,map_nf:0.0424,map_insert:0.0930,map_erase:0.0520,map_iter:0.0085,map_mem:36432,umap_fnd:0.0027,umap_nf:0.0054,umap_insert:0.0177,umap_erase:0.0059,umap_iter:0.0015,umap_mem:24304,kntrie_memneeded:12296},
  {pattern:"sequential",N:1139,kntrie_fnd:0.0163,kntrie_nf:0.0135,kntrie_insert:0.1014,kntrie_erase:0.0293,kntrie_iter:0.0427,kntrie_mem:49240,map_fnd:0.0752,map_nf:0.0772,map_insert:0.1432,map_erase:0.0765,map_iter:0.0142,map_mem:54672,umap_fnd:0.0039,umap_nf:0.0087,umap_insert:0.0236,umap_erase:0.0076,umap_iter:0.0024,umap_mem:36880,kntrie_memneeded:24584},
  {pattern:"sequential",N:1708,kntrie_fnd:0.0213,kntrie_nf:0.0180,kntrie_insert:0.1373,kntrie_erase:0.0432,kntrie_iter:0.0656,kntrie_mem:49240,map_fnd:0.1259,map_nf:0.1301,map_insert:0.2237,map_erase:0.1240,map_iter:0.0221,map_mem:81984,umap_fnd:0.0060,umap_nf:0.0131,umap_insert:0.0340,umap_erase:0.0123,umap_iter:0.0034,umap_mem:54920,kntrie_memneeded:24584},
  {pattern:"sequential",N:2562,kntrie_fnd:0.0365,kntrie_nf:0.0314,kntrie_insert:0.2203,kntrie_erase:0.0661,kntrie_iter:0.1028,kntrie_mem:73816,map_fnd:0.2097,map_nf:0.2093,map_insert:0.3416,map_erase:0.1940,map_iter:0.0331,map_mem:122976,umap_fnd:0.0091,umap_nf:0.0209,umap_insert:0.0475,umap_erase:0.0184,umap_iter:0.0049,umap_mem:83512,kntrie_memneeded:49160},
  {pattern:"sequential",N:3844,kntrie_fnd:0.0548,kntrie_nf:0.0484,kntrie_insert:0.3133,kntrie_erase:0.1055,kntrie_iter:0.1549,kntrie_mem:73816,map_fnd:0.3533,map_nf:0.3445,map_insert:0.5613,map_erase:0.3013,map_iter:0.0484,map_mem:184512,umap_fnd:0.0136,umap_nf:0.0309,umap_insert:0.0708,umap_erase:0.0288,umap_iter:0.0073,umap_mem:124472,kntrie_memneeded:49160},
  {pattern:"sequential",N:5766,kntrie_fnd:0.2084,kntrie_nf:0.1754,kntrie_insert:0.6176,kntrie_erase:0.1486,kntrie_iter:0.2191,kntrie_mem:101728,map_fnd:0.5727,map_nf:0.5637,map_insert:0.8288,map_erase:0.4675,map_iter:0.0780,map_mem:276768,umap_fnd:0.0210,umap_nf:0.0454,umap_insert:0.1000,umap_erase:0.0446,umap_iter:0.0106,umap_mem:186008,kntrie_memneeded:36128},
  {pattern:"sequential",N:8649,kntrie_fnd:0.3144,kntrie_nf:0.2627,kntrie_insert:0.7550,kntrie_erase:0.2262,kntrie_iter:0.3251,kntrie_mem:168400,map_fnd:0.9422,map_nf:0.9430,map_insert:1.2990,map_erase:0.7775,map_iter:0.1230,map_mem:415152,umap_fnd:0.0315,umap_nf:0.0672,umap_insert:0.1500,umap_erase:0.0673,umap_iter:0.0156,umap_mem:277840,kntrie_memneeded:53936},
  {pattern:"sequential",N:12974,kntrie_fnd:0.4712,kntrie_nf:0.3928,kntrie_insert:0.9656,kntrie_erase:0.3242,kntrie_iter:0.4940,kntrie_mem:277536,map_fnd:1.5528,map_nf:1.5495,map_insert:2.0337,map_erase:1.2038,map_iter:0.1943,map_mem:622752,umap_fnd:0.0454,umap_nf:0.0981,umap_insert:0.2274,umap_erase:0.1038,umap_iter:0.0231,umap_mem:415240,kntrie_memneeded:81008},
  {pattern:"sequential",N:19461,kntrie_fnd:0.7156,kntrie_nf:0.5895,kntrie_insert:1.3751,kntrie_erase:0.4933,kntrie_iter:0.7462,kntrie_mem:375376,map_fnd:2.5914,map_nf:2.6082,map_insert:3.2614,map_erase:1.9472,map_iter:0.2993,map_mem:934128,umap_fnd:0.0701,umap_nf:0.1572,umap_insert:0.3333,umap_erase:0.1600,umap_iter:0.0346,umap_mem:633088,kntrie_memneeded:121280},
  {pattern:"sequential",N:29192,kntrie_fnd:1.0926,kntrie_nf:0.8975,kntrie_insert:1.9823,kntrie_erase:0.7814,kntrie_iter:1.1188,kntrie_mem:599872,map_fnd:4.4477,map_nf:4.4880,map_insert:5.1865,map_erase:3.2348,map_iter:0.5502,map_mem:1401216,umap_fnd:0.1121,umap_nf:0.2339,umap_insert:0.5223,umap_erase:0.2616,umap_iter:0.0525,umap_mem:946424,kntrie_memneeded:181936},
  {pattern:"sequential",N:43789,kntrie_fnd:1.6781,kntrie_nf:1.3704,kntrie_insert:3.6669,kntrie_erase:1.3638,kntrie_iter:1.8608,kntrie_mem:804736,map_fnd:8.0519,map_nf:8.2420,map_insert:8.6573,map_erase:5.6390,map_iter:1.3829,map_mem:2101872,umap_fnd:0.2571,umap_nf:0.3889,umap_insert:0.7770,umap_erase:0.5172,umap_iter:0.0802,umap_mem:1414784,kntrie_memneeded:272480},
  {pattern:"sequential",N:65684,kntrie_fnd:2.6048,kntrie_nf:2.2014,kntrie_insert:5.2936,kntrie_erase:2.1175,kntrie_iter:2.7989,kntrie_mem:1265480,map_fnd:15.1033,map_nf:14.7282,map_insert:14.6995,map_erase:9.6957,map_iter:2.4885,map_mem:3152832,umap_fnd:0.5520,umap_nf:0.7431,umap_insert:1.2118,umap_erase:0.9170,umap_iter:0.1224,umap_mem:2114872,kntrie_memneeded:409512},
  {pattern:"sequential",N:98526,kntrie_fnd:3.9596,kntrie_nf:3.2165,kntrie_insert:7.9684,kntrie_erase:3.2401,kntrie_iter:4.1893,kntrie_mem:1977208,map_fnd:25.0777,map_nf:25.1491,map_insert:24.5628,map_erase:15.9246,map_iter:4.1900,map_mem:4729248,umap_fnd:0.9456,umap_nf:1.2084,umap_insert:1.8774,umap_erase:1.6749,umap_iter:0.1867,umap_mem:3162488,kntrie_memneeded:613304},
];


const LINES_FIND = [
  { key: "kntrie", suffix: "fnd", color: "#3b82f6", dash: [],    width: 2.5, label: "kntrie FND" },
  { key: "kntrie", suffix: "nf", color: "#93c5fd", dash: [6,3], width: 1.5, label: "kntrie NF" },
  { key: "map",    suffix: "fnd", color: "#ef4444", dash: [],    width: 2.5, label: "map FND" },
  { key: "map",    suffix: "nf", color: "#fca5a5", dash: [6,3], width: 1.5, label: "map NF" },
  { key: "umap",   suffix: "fnd", color: "#22c55e", dash: [],    width: 2.5, label: "umap FND" },
  { key: "umap",   suffix: "nf", color: "#86efac", dash: [6,3], width: 1.5, label: "umap NF" },
];

const LINES_OP = [
  { key: "kntrie", suffix: "insert", color: "#3b82f6", dash: [], width: 2.5, label: "kntrie" },
  { key: "map",    suffix: "insert", color: "#ef4444", dash: [], width: 2.5, label: "map" },
  { key: "umap",   suffix: "insert", color: "#22c55e", dash: [], width: 2.5, label: "umap" },
];

const LINES_ERASE = [
  { key: "kntrie", suffix: "erase", color: "#3b82f6", dash: [], width: 2.5, label: "kntrie" },
  { key: "map",    suffix: "erase", color: "#ef4444", dash: [], width: 2.5, label: "map" },
  { key: "umap",   suffix: "erase", color: "#22c55e", dash: [], width: 2.5, label: "umap" },
];

const LINES_MEM = [
  { key: "kntrie", suffix: "mem", color: "#3b82f6", dash: [], width: 2.5, label: "kntrie" },
  { key: "kntrie", suffix: "memneeded", color: "#93c5fd", dash: [6,3], width: 1.5, label: "kntrie needed" },
  { key: "map",    suffix: "mem", color: "#ef4444", dash: [], width: 2.5, label: "map" },
  { key: "umap",   suffix: "mem", color: "#22c55e", dash: [], width: 2.5, label: "umap" },
  { key: "raw",    suffix: "mem", color: "#888",    dash: [3,3], width: 1, label: "raw (16B)" },
];

const LINES_ITER = [
  { key: "kntrie", suffix: "iter", color: "#3b82f6", dash: [], width: 2.5, label: "kntrie" },
  { key: "map",    suffix: "iter", color: "#ef4444", dash: [], width: 2.5, label: "map" },
  { key: "umap",   suffix: "iter", color: "#22c55e", dash: [], width: 2.5, label: "umap" },
];

const METRICS = [
  { id: "find",   lines: LINES_FIND,  convert: (ms, n) => (ms * 1e6) / n },
  { id: "iter",   lines: LINES_ITER,  convert: (ms, n) => (ms * 1e6) / n },
  { id: "insert", lines: LINES_OP,    convert: (ms, n) => (ms * 1e6) / n },
  { id: "erase",  lines: LINES_ERASE, convert: (ms, n) => (ms * 1e6) / (n / 2) },
  { id: "mem",    lines: LINES_MEM,   convert: (b, n) => b / n },
];

function buildData(pattern, metric) {
  return RAW_DATA
    .filter(r => r.pattern === pattern)
    .map(r => {
      const pt = { N: r.N };
      for (const l of metric.lines) {
        if (l.key === "raw") { pt["raw_mem"] = 16; continue; }
        const raw = r[l.key + "_" + l.suffix];
        if (raw != null) pt[l.key + "_" + l.suffix] = metric.convert(raw, r.N);
      }
      return pt;
    });
}

const charts = {};

function makeChart(canvasId, metric) {
  const ctx = document.getElementById(canvasId).getContext("2d");
  const data = buildData("random", metric);

  charts[canvasId] = new Chart(ctx, {
    type: "line",
    data: {
      labels: data.map(d => d.N),
      datasets: metric.lines.map(l => ({
        label: l.label,
        data: data.map(d => d[l.key === "raw" ? "raw_mem" : l.key + "_" + l.suffix] ?? null),
        borderColor: l.color,
        backgroundColor: l.color + "33",
        borderWidth: l.width,
        borderDash: l.dash,
        pointRadius: 0,
        pointHitRadius: 8,
        tension: 0.2,
        spanGaps: true,
      })),
    },
    options: {
      responsive: true,
      interaction: { mode: "index", intersect: false },
      plugins: {
        legend: { display: true, labels: { color: "#bbb", font: { size: 11 }, boxWidth: 20, padding: 10 } },
        tooltip: {
          backgroundColor: "#1a1a2e",
          borderColor: "#444",
          borderWidth: 1,
          titleColor: "#aaa",
          bodyColor: "#ddd",
          callbacks: {
            title: (items) => {
              const v = items[0].parsed.x;
              if (v >= 1e6) return "N = " + (v/1e6).toFixed(1) + "M";
              if (v >= 1e3) return "N = " + (v/1e3).toFixed(1) + "K";
              return "N = " + v;
            },
            label: (item) => {
              const v = item.parsed.y;
              if (v == null) return null;
              const s = v < 0.1 ? v.toFixed(3) : v < 10 ? v.toFixed(2) : v < 1000 ? v.toFixed(1) : v.toFixed(0);
              return " " + item.dataset.label + ": " + s;
            },
          },
        },
      },
      scales: {
        x: {
          type: "logarithmic",
          title: { display: false },
          ticks: { color: "#888", font: { size: 11 },
            callback: (v) => v >= 1e6 ? (v/1e6)+"M" : v >= 1e3 ? (v/1e3)+"K" : v },
          grid: { color: "#2a2a3e" },
        },
        y: {
          type: "logarithmic",
          ticks: { color: "#888", font: { size: 10 },
            callback: (v) => v < 0.1 ? v.toFixed(2) : v < 10 ? v.toFixed(1) : v >= 1000 ? v.toFixed(0) : v.toFixed(1) },
          grid: { color: "#2a2a3e" },
        },
      },
    },
  });
  charts[canvasId]._metric = metric;
}

METRICS.forEach(m => makeChart("c_" + m.id, m));

function show(pattern) {
  document.querySelectorAll(".btns button").forEach(b => b.classList.remove("active"));
  event.target.classList.add("active");
  for (const [id, chart] of Object.entries(charts)) {
    const m = chart._metric;
    const data = buildData(pattern, m);
    chart.data.labels = data.map(d => d.N);
    m.lines.forEach((l, i) => {
      chart.data.datasets[i].data = data.map(d => d[l.key === "raw" ? "raw_mem" : l.key + "_" + l.suffix] ?? null);
    });
    chart.update("none");
  }
}
</script>
</body>
</html>
